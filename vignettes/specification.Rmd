---
title: File specification for delayed operations
author:
- name: Aaron Lun
  email: infinite.monkeys.with.keyboards@gmail.com
date: "Revised: 2021-05-02"
package: DelayedArraySaver
output:
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{2. Format specification}
  %\VignetteEngine{knitr::rmarkdown}
  %VignetteEncoding{UTF-8}  
---

# Overview

This document describes the layout of a HDF5 file containing delayed operations on an array.
The general strategy is to use a hierarchical format where each level stores information about the operation and the "seed" array that it operates on;
the seed itself can then be another operation, and so on, until all operations are resolved.

# Basic structures

Lists are stored as HDF5 groups with no `delayed_type` attribute.
The group will contain `delayed_length` attribute, which is a length-1 integer array containing the number of elements in the list.
The group elements are named by their positional index from 1 to the total number of elements; indices are allowed to be missing, in which case they are assumed to represent `NULL` or `None` elements.
The group may also contain a `delayed_names` attribute, which is a 1D array of strings of length equal to `delayed_length`, containing the names of the elements.

Delayed operations are represented by a HDF5 group with a `delayed_type` attribute containing a length-2 string dataset, where the first string is `"operation"` and the second string specifies the category of the operation.
Possible operations are described below.

Seed arrays are represented by a HDF5 group with a `delayed_type` attribute containing a length-2 string dataset, where the first string is `"seed"` and the second string specifies the class of the seed.
Possible seed classes are described below.

# Operations

## Subsetting

For subsetting operations, the second string in `delayed_type` is `"subset"`.
The group contains the following elements:

- `index`, a list of 1D integer datasets. 
  The list is of length equal to the number of dimensions in the seed array.
  Each dataset can be of variable length and contains (possibly duplicated, possibly unsorted) 1-based indices to subset the seed array in the corresponding dimension.
  If a list entry is missing, no subsetting is to be performed on that dimension.
- `seed`, the seed array to be subsetted.

## Combining 

For combining operations, the second string in `delayed_type` is `"combine"`.
The group contains the following elements:

- `along`, a 1D integer dataset of length 1 containing the dimension to combine along.
  A value of 1 indicates that seed arrays should be combined along rows,
  while a value of 2 indicates that seed arrays should be combined along columns.
- `seeds`, a list of seed arrays to be combined.
  Dimensions of seed arrays should be identical except for the `along` dimension.

## Stacked unary isometric operations

For stacked unary operations, the second string in `delayed_type` is `"unary isometric stack"`.
The group contains the following elements:

- `seed`, the seed array to be operated on.
  Note that the "unary" in the name of this operation refers to the fact that we are only operating on one seed array.
- `operations`, a group describing the stack of unary operations to perform.
Each operation is represented by a group that is named by the execution order, i.e., `1` is performed first, then `2`, and so on.
Each group in `operations` contains at least `operation`, a 1D string dataset of length 1 containing the name of the operation to perform.

Operations fall into several categories.
The `Math` category takes no additional arguments and contains the following members, most of whom should be fairly self-explanatory:

```{r, echo=FALSE}
getGroupMembers("Math")
```

The `Math2` category takes an additional `digits` argument, which is stored as a 1D integer dataset of length 1 inside the operation's group.
Members of this category are:

```{r, echo=FALSE}
getGroupMembers("Math2")
```

Finally, the `Ops` category contain binary operations where one of the arguments is the seed array.
The operation's group contains `side`, a 1D string dataset of length 1 specifying which side of the seed array the operation should be applied to, i.e., `"left"` or `"right"`.
It also contains `value`, a 1D dataset of length 1 containing the value of the other argument.

```{r, echo=FALSE}
c(
    getGroupMembers("Compare"), 
    getGroupMembers("Arith"), 
    getGroupMembers("Logic") 
)
```

## Unary isometric operation with arguments

For an unary operation with arguments, the second string in `delayed_type` is `"unary isometric with arguments"`.
The group contains the following elements:

- `seed`, the seed array to be operated on.
  Note that the "unary" in the name of this operation refers to the fact that we are only operating on one seed array.
- `operation`, a 1D string dataset of length 1 containing the name of the operation to perform.
- `left_arguments`, a list of 1D datasets containing the arguments on the left of the seed array when performing the specified `operation`.
  Each dataset should have length equal to the length of the relevant dimension of the seed array, as specified in `left_along`.
- `left_along`, an 1D integer dataset of length equal to `left_arguments`.
  Each entry of `left_along` specifies the dimensions along which the corresponding dataset in `left_arguments` is applied.
  A value of 1 means that the each entry of the corresponding `left_arguments` dataset is applied to a separate row, while a value of 2 means that each entry is applied to the columns.
- `right_arguments`, a list of 1D datasets containing the arguments on the right of the seed array when performing the specified `operation`.
- `right_along`, a 1D integer dataset of the dimensions along which the corresponding dataset in `right_arguments` is applied.

Currently supported operations are `+`, `-`, `/`, `*` and `^`.
All datasets in `*_arguments` are currently expected to be integer or double-precision.

## Transposition

For transposition, the second string in `delayed_type` is `"transpose"`.
The group contains the following elements:

- `seed`, the seed array to be transposed.
- `permutation`, a 1D integer dataset of length equal to the number of dimensions.
  This specifies the permutation of the dimensions - for example, a dataset with values of `[2, 1]` would represent transposition of a matrix.

## Subarray assignment

For subarray assignment, the second string in `delayed_type` is `"subassign"`.
The group contains the following elements:

- `seed`, the seed array on which to perform the assignment. 
- `index`, a list of 1D integer datasets containing the indices in which to perform the assignment.
  The list is of length equal to the number of dimensions in the seed array.
  Each dataset can be of variable length and contains 1-based indices to define the subarray in the corresponding dimension.
  If a list entry is missing, no subsetting is to be performed on that dimension.
- `value`, another seed array containing the replacement values.
  This should have the same dimensions as the subarray specified by `index`.

## Dimnames

For dimnames replacement, the second string in `delayed_type` is `"dimnames"`.
The group contains the following elements:

- `seed`, the seed array on which to perform the assignment. 
- `dimnames`, a list of 1D string datasets containing the new dimnames. 
  The list is of length equal to the number of dimensions in the seed array.
  Each dataset is of length equal to the size of the corresponding dimension.
  If a list entry is missing, no dimnames are defined for that dimension.

## N-ary isometric operations

For an N-ary isommetric operation, the second string in `delayed_type` is `"n-ary isometric"`.
The group contains the following elements:

- `seeds`, a list of seed arrays to be operated on.
  All arrays should have the same dimensions.
- `operation`, a 1D string dataset of length 1 containing the name of the operation to perform.
- `right_arguments`, a list of additional arguments to be used in the operation, to the right of all `seeds`.

Currently supported operations are `+`, `-`, `/`, `*` and `^`.

# Seed classes

## Ordinary arrays

For ordinary arrays, the second string in `delayed_type` is `"array"`.
This group contains:

- `data`, a dataset containing the array values.
- `dimnames` (optional), a list of string datasets containing the dimension names.
  The list is of length equal to the number of dimensions in the array.
  Each dataset is of length equal to the size of the corresponding dimension.
  If a list entry is missing, no dimnames are defined for that dimension.

## Column sparse matrix

For compressed sparse column matrices, the second string in `delayed_type` is `"csparse matrix"`.
This group contains:

- `data`, a 1D dataset containing the non-zero values.
- `indices`, a 1D integer dataset of the same length as `data`, containing the row indices of the non-zero values.
- `indptr`, a 1D integer dataset of length equal to the number of columns plus 1, containing the location on `indices` representing the start of each column.

The orientation is stored in the `h5sparse_format` attribute as `csc-matrix`.
The shape is stored as a length-2 integer array in the `h5sparse_shape` attribute.

## External HDF5 array

For dense HDF5 arrays, the second string in `delayed_type` is `"external hdf5 array"`.
This group contains:

- `path`, a 1D string dataset of length 1 containing the path to the external HDF5 file.
- `name`, a 1D string dataset of length 1 containing the name of the dataset inside that file.
- `sparse`, a length-1 integer vector to be interpreted as a boolean (0 for false, 1 for true),
  indicating whether the dataset values can be treated as sparse.

## External sparse HDF5 matrix

For sparse HDF5 matrices, the second string in `delayed_type` is `"external sparse hdf5 matrix"`.

This group contains:

- `path`, a 1D string dataset of length 1 containing the path to the external HDF5 file.
- `name`, a 1D string dataset of length 1 containing the name of the group inside that file.

The referenced group should contain the data, indices and index pointers in compressed sparse column/row format - see Section \@ref(column-sparse-matrix) for an example.

## External H5AD matrix

For matrices in H5AD files, the second string in `delayed_type` is `"external h5ad matrix"`.
This group contains:

- `path`, a 1D string dataset of length 1 containing the path to the external H5AD file.
- `layer` (optional), a 1D string dataset of length 1 specifying the name of the layer of interest.
  If missing, the matrix is assumed to refer to the main matrix `X`.

## External 10X matrix

For matrices in 10X HDF5 count files, the second string in `delayed_type` is `"external tenx matrix"`.
This group contains:

- `path`, a 1D string dataset of length 1 containing the path to the external H5AD file.
- `name`, a 1D string dataset of length 1 containing the name of the group inside that file.
